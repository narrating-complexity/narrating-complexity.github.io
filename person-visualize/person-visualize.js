
QUILL_ICONS = {
    'NAV_FULL_RECORD': 'icons2/nav/icons2/nav/navigation-full-record-large.svg',
    'NAV_SECRETARY': 'icons2/nav/navigation-secretary-desk-large.svg',
    'NAV_ORIENTATION': 'icons2/nav/navigation-orientation-large.svg',
    'NAV_LIBRARY': 'icons2/nav/navigation-library-large.svg',
    'NAV_COMMITTEE_LIBRARY': 'icons2/nav/navigation-library-large.svg',
    'NAV_EXPLORE': 'icons2/nav/navigation-explore-large.svg',
    'NAV_CALENDAR': 'icons2/nav/navigation-calendar-large.svg',
    'NAV_ACTIVITY': 'icons2/nav/navigation-activity-large.svg',
    'NAV_STATISTICS': 'icons2/nav/navigation-statistics-large.svg',
    'NAV_QUILL': 'icons2/icon-tool-quill.svg',

    'UI_ADD_COMMENTARY': 'icons2/icon-edit-add-commentary.svg',
    'UI_ADD_SESSION_NEXT': 'icons2/icon-edit-add-session-next.svg',
    'UI_ADD_SESSION_PREVIOUS': 'icons2/icon-edit-add-session-previous.svg',
    'UI_SESSION_NEXT': 'icons2/icon-session-next.svg',
    'UI_SESSION_PREVIOUS': 'icons2/icon-session-previous.svg',
    'UI_VISUALIZE': 'icons2/icon-view.svg',
    'UI_VISUALIZE_DOCUMENTS': 'icons2/icon-tool-search.svg',
    'UI_READERS_VIEW': 'icons2/icon-view.svg',
    'UI_COMPARE_DOC': 'icons2/icon-doc-compare.svg',
    'UI_TIMELINE_CREATE': 'icons2/icon-doc-create.svg',
    'UI_TIMELINE_EXPLORE': 'icons2/icon-tool-explore.svg',
    'UI_USER_INFO': 'icons2/icon-tool-information.svg',
    'UI_PROJECTS_LIST': 'icons2/icon-tool-projects.svg',

    'PAGE_SECRETARY_DATA_ENTRY': 'icons2/icon-tool-quill.svg',
    'PAGE_COMMITTEE_DOCUMENT_LIBRARY': 'icons2/icon-tool-library.svg',

    'SOURCE_MATERIAL': 'icons2/icon-tool-library.svg',
    'COMMENTARY_COLLECTION': 'icons2/icon-tool-commentary.svg',
    'COMMENTARY_ITEM': 'icons2/icon-tool-commentary.svg',
    'RESOURCE_COLLECTION': 'icons2/icon-tool-resources.svg',
    'RESOURCE_ITEM': 'icons2/icon-tool-resources.svg',
    'RESOURCES_LIST': 'icons2/icon-tool-resources.svg',
    'COMMENTARY_LIST': 'icons2/icon-tool-commentary.svg',

    'CONVENTION': 'icons2/nav/navigation-timeline-large.svg',
    'LIBRARY_COLLECTION': 'icons2/nav/navigation-library-collection-small.svg',

    'PERSON': 'icons2/icon-tool-person.svg',
    'DELEGATION': 'icons2/icon-tool-delegation.svg',
    'COMMITTEE': 'icons2/icon-tool-committee.svg',
    'SESSION': 'icons2/icon-session-committee.svg',

    'JOIN': 'icons2/icon-people-join.svg',
    'JOIN_NON_VOTING': 'icons2/icon-people-join.svg',
    'LEAVE_NON_VOTING': 'icons2/icon-people-leave.svg',

    'LEAVE': 'icons2/icon-people-leave.svg',
    'CLEAR_MEMBERSHIP': 'icons2/icon-people-blank.svg',
    'ROLL_CALL': 'icons2/icon-people-attendance.svg',
    'PERSON': 'icons2/icon-people-blank.svg',
    'ELECTION': 'icons2/icon-people-vote.svg',

    'DOC_BLANK': 'icons2/icon-doc-blank.svg',
    'DECISION_BLANK': 'icons2/icon-decision-blank.svg',
    'DOC_COMPONENTS': 'icons2/icon-doc-components.svg',

    'CREATE': 'icons2/icon-doc-subtype-script-add.svg',
    'CREATE:LEGISLATION': 'icons2/icon-doc-subtype-legislation-add.svg',
    'CREATE:MESSAGE': 'icons2/icon-doc-subtype-message-add.svg',
    'CREATE:PETITION': 'icons2/icon-doc-subtype-petition-add.svg',
    'CREATE:RESOLUTION': 'icons2/icon-doc-subtype-decision-add.svg',
    'CREATE:RULES': 'icons2/icon-doc-subtype-procedure-add.svg',
    'CREATE:PRESS_RELEASE': 'icons2/icon-doc-subtype-pressrelease-add.svg',
    'CREATE:POSITION_PAPER': 'icons2/icon-doc-subtype-positionpaper-add.svg',
    'CREATE:CONJECTURAL_DOCUMENT': 'icons2/icon-doc-subtype-conjectural-add.svg',

    'DOCUMENT_NO_DECISION': 'icons2/icon-doc-script.svg',
    'DOCUMENT_ADOPTED': 'icons2/icon-doc-compound-decision-adopt.svg',
    'DOCUMENT_REJECTED': 'icons2/icon-doc-compound-decision-reject.svg',
    'DOCUMENT_OTHER': 'icons2/icon-doc-compound-decision-other.svg',
    'DOCUMENT_DROPPED': 'icons2/icon-doc-compound-decision-drop.svg',
    'DOCUMENT_REFERRED': 'icons2/icon-doc-compound-decision-refer.svg',
    'DOCUMENT_POSTPONED': 'icons2/icon-doc-compound-decision-postpone.svg',

    'CREATE_FROM': 'icons2/icon-doc-subtype-script-import.svg',
    'CREATE_FROM:LEGISLATION': 'icons2/icon-doc-subtype-legislation-import.svg',
    'CREATE_FROM:MESSAGE': 'icons2/icon-doc-subtype-message-import.svg',
    'CREATE_FROM:PETITION': 'icons2/icon-doc-subtype-petition-import.svg',
    'CREATE_FROM:RESOLUTION': 'icons2/icon-doc-subtype-decision-import.svg',
    'CREATE_FROM:RULES': 'icons2/icon-doc-subtype-procedure-import.svg',
    'CREATE_FROM:PRESS_RELEASE': 'icons2/icon-doc-subtype-pressrelease-import.svg',
    'CREATE_FROM:POSITION_PAPER': 'icons2/icon-doc-subtype-positionpaper-import.svg',
    'CREATE_FROM:CONJECTURAL_DOCUMENT': 'icons2/icon-doc-subtype-conjectural-import.svg',

    'CREATE::LINE_BY_LINE': 'icons2/icon-doc-subtype-script-amend.svg',
    'CREATE:LEGISLATION:LINE_BY_LINE': 'icons2/icon-doc-subtype-legislation-amend.svg',
    'CREATE:MESSAGE:LINE_BY_LINE': 'icons2/icon-doc-subtype-message-amend',
    'CREATE:PETITION:LINE_BY_LINE': 'icons2/icon-doc-subtype-petition-amend.svg',
    'CREATE:RESOLUTION:LINE_BY_LINE': 'icons2/icon-doc-subtype-decision-amend.svg',
    'CREATE:RULES:LINE_BY_LINE': 'icons2/icon-doc-subtype-procedure-amend.svg',
    'CREATE:PRESS_RELEASE:LINE_BY_LINE': 'icons2/icon-doc-subtype-pressrelease-amend.svg',
    'CREATE:POSITION_PAPER:LINE_BY_LINE': 'icons2/icon-doc-subtype-positionpaper-amend.svg',
    'CREATE:CONJECTURAL_DOCUMENT:LINE_BY_LINE': 'icons2/icon-doc-subtype-conjectural-amend.svg',
    
    'CREATE::REVISION': 'icons2/icon-doc-subtype-script-amend.svg',
    'CREATE:LEGISLATION:REVISION': 'icons2/icon-doc-subtype-legislation-amend.svg',
    'CREATE:MESSAGE:REVISION': 'icons2/icon-doc-subtype-message-amend.svg',
    'CREATE:PETITION:REVISION': 'icons2/icon-doc-subtype-petition-amend.svg',
    'CREATE:RESOLUTION:REVISION': 'icons2/icon-doc-subtype-decision-amend.svg',
    'CREATE:RULES:REVISION': 'icons2/icon-doc-subtype-procedure-amend.svg',
    'CREATE:PRESS_RELEASE:REVISION': 'icons2/icon-doc-subtype-pressrelease-amend.svg',
    'CREATE:POSITION_PAPER:REVISION': 'icons2/icon-doc-subtype-positionpaper-amend.svg',
    'CREATE:CONJECTURAL_DOCUMENT:REVISION': 'icons2/icon-doc-subtype-conjectural-amend.svg',

    'ADOPT_PROPOSAL': 'icons2/icon-decision-adopt.svg',
    'NO_OBJECTION': 'icons2/icon-decision-implied-adopt.svg',
    'REJECT_PROPOSAL': 'icons2/icon-decision-reject.svg',
    'DROP_PROPOSAL': 'icons2/icon-decision-drop.svg',
    'REPORT_PROPOSAL': 'icons2/icon-decision-refer.svg',
    'OTHER': 'icons2/icon-decision-forward.svg',
    'OTHER_OR_REJECT': 'icons2/icon-decision-alternatives-forward-reject.svg',
    'ACCEPT_OR_REJECT': 'icons2/icon-decision-alternatives-accept-reject.svg',
    'POSTPONE_DEBATE': 'icons2/icon-decision-postpone.svg',

    'DEBATE_PROPOSAL': 'icons2/icon-doc-debate.svg',
    'DEBATE_PROPOSAL:QUESTION': 'icons2/icon-doc-debate.svg',

    'PROPOSE_DOCUMENT_AMENDMENT': 'icons2/icon-doc-amend.svg',
    'IMPORT_FROM': 'icons2/icon-doc-amend-import.svg',

    'DEBATE_MOTION': 'icons2/icon-procedure-debate.svg',
    'DEBATE_MOTION:QUESTION': 'icons2/icon-procedure-debate.svg',

    'PROCEDURE': 'icons2/icon-procedure-motion.svg',
    'PROCEDURE:AGENDAITEM': 'icons2/icon-procedure-blank.svg',
    'PROCEDURE.withSubdecisions': 'icons2/icon-procedure-motion-with-subdecisions.svg',
    'PROCEDURE:AGENDA_ITEM': 'icons2/icon-procedure-blank.svg',
    'PROCEDURE:AGENDA_ITEM.withSubdecisions': 'icons2/icon-procedure-motion-with-subdecisions.svg',

    'EXTERNAL_MOMENT': 'icons2/icon-orientation-external.svg',
    'SECTION_MARKER': 'icons2/icon-orientation-blank.svg',
    'ELLIPSIS': 'icons2/icon-orientation-ellipsis.svg',

    'PROPOSALS_WAITING': 'icons2/icon-doc-vote.svg',

    'DOCUMENT_ICON_BLANK': 'icons2/icon-doc-blank.svg',
    'DECISION_ICON_BLANK': 'icons2/icon-decision-adopt.svg',
    'PEOPLE_ICON_BLANK': 'icons2/icon-people-blank.svg',
    'PROCEDURAL_ICON_BLANK': 'icons2/icon-procedure-blank.svg',
}

var personVisualize = {};

personVisualize.variables = {
    personId: -1,
    personEvents: {},
    committeeId: -1,
    convention: {},
    maxYScaleNumberOfEvents: -1,
    type: '',

    secondPersonId: -1,

    personName: '',
    committeeName: '',
    secondPersonName: '',

    involvements : null,
    votes: null,
    filteredVotes: null,
    events: null,
    filteredEvents: null,
    relationships: null,
    keywords: null,

    rawData: null,
    //isEventTimelineUpToDate: false
};

personVisualize.prototype = {
    init: function() {
        personVisualize.variables.type = "person";
        personVisualize.variables.personId = 4564;
        personVisualize.variables.personName = "Thaddeus Stevens"

        personVisualize.variables.secondPersonId = 4501;
        personVisualize.variables.secondPersonName = "Andrew J. Rogers"

        personVisualize.prototype.getPersonConventionInvolvements();
        personVisualize.prototype.setupButtons();
    },

    //Ajax request to get list of all sessions for all committees, and count how many events in each session that person has participated.
    //Afterwards, call visualization functions and other get functions.
    getPersonConventionInvolvements: function() {
        //console.log("getPersonConventionInvolvements called.");
        d3v5.json("data/persondata_143_4564.json").then(function(d){
            personVisualize.variables.rawData = d;
            var response = personVisualize.variables.rawData.getPersonConventionInvolvements;
            personVisualize.variables.convention = response.convention;

            $('#committee-list-person-name')[0].innerHTML = personVisualize.variables.personName;
            personVisualize.prototype.visualizeListOfCommittees(response.convention);

            // initialize person events vis
            personVisualize.prototype.getCommitteeKeywords();
            personVisualize.prototype.getPersonRelationships();
            personVisualize.prototype.getAllEventsCommitteeBySession();
            personVisualize.prototype.getPersonVotesCommitteeBySession();
        });
    },

    //Creates committee svgs and draws involvement donuts
    visualizeListOfCommittees: function(convention) {
        //console.log("visualizeListOfCommittees called.");
        $('#list-view-committees').empty();

        var involvements = convention.committees.map(function(committee) {
            var total_involvement = d3.sum(committee.sessions, function(d) { return d.no_of_events_involved_in; });
            var total_events = d3.sum(committee.sessions, function(d) { return d.total_events_in_session; });
            var new_array = [];
            if (total_events == 0) total_events = 1;
            new_array.push({'committee_id': committee.committee_id, 'type': 'involvement', 'total': total_involvement});
            new_array.push({'committee_id': committee.committee_id, 'type': 'non-involvement', 'total': total_events - total_involvement});
            committee["total_involvement"] = total_involvement;
            committee["total_events"] = total_events;
            return new_array;
        });
        //G: is this the best way to structure this data?

        convention.committees.sort(function(a,b){
            return a.total_involvement - b.total_involvement;
            //return (a.total_involvement/a.total_events) - (b.total_involvement/b.total_events);
            //uncomment above to order by % of events participated
        }).reverse();
        //comment this whole statement to disable ordering

        convention.committees.forEach(function(committee) {
            if (committee.total_involvement != 0)
                var classname = 'committee-list-view-cell text-center committee-list-valid-cell';
            else
                var classname = 'committee-list-view-cell text-center';

            var block = 
                '<div class="' + classname + '" id="committee-row-' + committee.committee_id +'">' +
                    '<div id="committee-cell-summary-' + committee.committee_id +'">' + 
                        '<div id="committee-cell-summary-svg-' + committee.committee_id +'">' + 
                        '</div>' + 
                    '</div>' +
                    '<div id="committee-cell-' + committee.committee_id +'">' + committee.committee_name + 
                    '</div>' + 
                '</div>';
            $('#list-view-committees').append(block);
        });

        // select the first row
        d3.select('#list-view-committees div:first-child').classed("cell_selected", true);
        $('#committee-clicked-text').text($('#list-view-committees div:first-child div:nth-child(2)').text());
        $('#committee-clicked-text-voting').text($('#list-view-committees div:first-child div:nth-child(2)').text());
        // get the relevant committee
        var id = $('#list-view-committees div:first-child div:nth-child(2)').attr('id');
        var committee_id = id.split('-');
        committee_id = committee_id[committee_id.length - 1];
        personVisualize.variables.committeeId = committee_id;

        personVisualize.variables.committeeName = $('#committee-cell-' + committee_id).text();

        // get the relevant committee
        var result = $.grep(personVisualize.variables.convention.committees, function(e){ return e.committee_id === parseInt(committee_id); });
        var totalEvents = d3.sum(result[0].sessions, function(d) { return d.total_events_in_session; });
        $('#no-of-sessions').text(result[0].sessions.length);
        $('#no-of-events').text(totalEvents);


        //Start drawing participation donuts

        var width = 50,
        height = 50,
        radius = Math.min(width, height) / 2;

        //donut filling colors
        var color = d3.scale.ordinal()
                        .range(['#bf3e11', '#f6b098']);

        var dcolor = ['#d7d8d2'];

        var arc = d3.svg.arc()
                .outerRadius(radius)
                .innerRadius(radius - 10);

        $.each(involvements, function(i, element) {
            var pie = d3.layout.pie()
                        .sort(null)
                        .padAngle(0.0)
                        .value(function (d) {
                            return d.total;
                        });

            var svg = d3.select('#committee-cell-summary-svg-' + element[0].committee_id).append('svg')
                    .attr('id', 'canvas-committee-cell-summary-svg-' + element[0].committee_id)
                    .attr('width', width)
                    .attr('height', height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            var g = svg.selectAll(".arc")
                .data(pie(element))
                .enter().append("g")
                .attr("class", "arc");

            if (element[0].total == 0) {
                g.append("path")
                .attr("d", arc)
                .style("fill", dcolor);
            }
            else {
                g.append("path")
                .attr("d", arc)
                .style("fill", function (d) {
                    return color(d.data.type);
                });
            }

            svg.append("text")
            .attr("x",1-(element[0].total.toString().length*5))
            .attr("y",5)
            .attr("fill",(element[0].total == 0? dcolor : color(0)))
            .attr("font-size","16px")
            .attr("font-family","monospace")
            .attr("font-weight","bold")
            .html(element[0].total);
        });
    },

    //Defines what happens when users click things on page
    setupButtons: function() {
        //Behavior for committee donuts
        /*$('#list-view-committees').on('click', '.committee-list-valid-cell', function() {
            var id = this.id;
            d3.select('.cell_selected').classed('cell_selected', false);
            $(this).addClass('cell_selected');
            // $('#committee-name-label').text($(this).text());
            d3.select('.selected').classed('selected', false);
            var committee_id = id.split('-');
            committee_id = committee_id[committee_id.length - 1];
            $('#committee-clicked-text').text($('#committee-cell-' + committee_id).text());
            $('#committee-clicked-text-voting').text($('#committee-cell-' + committee_id).text());
            d3.select('#committee-highlight-box-' + committee_id).classed('selected', true);
            // reset the committee id
            personVisualize.variables.committeeId = committee_id;
            personVisualize.variables.committeeName = $('#committee-cell-' + committee_id).text();

            // get the relevant committee
            var result = $.grep(personVisualize.variables.convention.committees, function(e){ return e.committee_id === parseInt(committee_id); });
            var totalEvents = d3.sum(result[0].sessions, function(d) { return d.total_events_in_session; });
            $('#no-of-sessions').text(result[0].sessions.length);
            $('#no-of-events').text(totalEvents);
            //$('#event-average-per-session').text((totalEvents / result[0].sessions.length).toFixed(1));

            personVisualize.prototype.getCommitteeKeywords();
            personVisualize.prototype.getPersonRelationships(); //only do this if relationships are based on committee
            personVisualize.prototype.getAllEventsCommitteeBySession();
            personVisualize.prototype.getPersonVotesCommitteeBySession();

            $('#committee-votes').text($(this).text());
        });*/

        //Behavior for events checkbox
        $('#checkbox-events-disable-filter')[0].checked = false;
        $('#checkbox-events-disable-filter')[0].onchange = function() {
            if (!this.checked) {
                personVisualize.prototype.visualizePersonEventsTimelineInACommittee(personVisualize.variables.filteredEvents);
            }
            else {
                personVisualize.prototype.visualizePersonEventsTimelineInACommittee(personVisualize.variables.events);
            }
        };

        //Behavior for votes checkbox
        $('#checkbox-votes-disable-filter')[0].checked = false;
        $('#checkbox-votes-disable-filter')[0].onchange = function() {
            if (!this.checked) {
                personVisualize.prototype.visualizePersonVotesInCommittee(personVisualize.variables.filteredVotes, personVisualize.variables.votes.max_votes_cast);
            }
            else {
                personVisualize.prototype.visualizePersonVotesInCommittee(personVisualize.variables.votes.votes, personVisualize.variables.votes.max_votes_cast);
            }
        };

        //Behavior for person comparison selector
        /*$('#selector-person-comparison')[0].onchange = function() {
        //document.getElementById("selector-person-comparison").onchange = function(){
            var newId = this.selectedOptions[0].value;
            if (newId != personVisualize.variables.secondPersonId) {
                personVisualize.variables.secondPersonId = this.selectedOptions[0].value;
                personVisualize.variables.secondPersonName = this.selectedOptions[0].text;
                $('#checkbox-votes-disable-filter')[0].checked = false;
                personVisualize.prototype.getPersonVotesCommitteeBySession();
            }
        };*/
    },

    //For a given committee, get info on all events from all sessions
    //Also gets keywords
    getAllEventsCommitteeBySession: function() {
        //console.log("getAllEventsCommitteeBySession called.");
        d3.select('#svg-canvas-person-events-timeline').remove();
        var response = personVisualize.variables.rawData.getAllEventsCommitteeBySession;
        personVisualize.variables.events = response.events;
        $('#event-list-person-name')[0].innerHTML = personVisualize.variables.personName;
        var filteredEvents = personVisualize.prototype.filterEventsByParticipation(response.events);
        personVisualize.variables.filteredEvents = filteredEvents;
        personVisualize.prototype.visualizePersonEventsTimelineInACommittee(filteredEvents);
    },

    //For a given committee, generates associated keywords
    getCommitteeKeywords: function() {
        //console.log("getCommitteeKeywords called.");
        d3.select('#word-cloud svg').remove();
        d3.select('#horizontal-bar svg').remove()
        d3.select('#svg-canvas-person-events-timeline').remove();

        var response = personVisualize.variables.rawData.generateCommitteeKeywords;
        personVisualize.variables.keywords = response.keywords;

        $('#wordcloud-committee-name')[0].innerHTML = personVisualize.variables.committeeName;
        personVisualize.prototype.visualizeWordCloud(response.keywords,personVisualize.variables.committeeName);
    },

    //YX Keyword Cloud
    //Draws keyword cloud
    visualizeWordCloud: function(keywords){   
        //console.log("visualizeWordCloud called.");

        var myWords = keywords
        var topWords = myWords.slice(0,20)
        var margin = {top: 10, right: 10, bottom: 10, left: 10},
        width = 640 - margin.left - margin.right,
        height = 480 - margin.top - margin.bottom;

        // clean canvas
        d3.select('#word-cloud svg').remove();
        d3.select('#horizontal-bar svg').remove()
        
        var svg = d3.select("#word-cloud").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Constructs a new cloud layout instance. It run an algorithm to find the position of words that suits your requirements
        // Wordcloud features that are different from one word to the other must be here
        var layout = d3.layout.cloud()
            .size([width, height])
            .words(myWords.map(function(d) { return {text: d.word, size:d.size}; }))
            .padding(5)        //space between words
            .rotate(function() { return ~~(Math.random() * 2) * 90; })
            .fontSize(function(d) { return d.size; })      // font size of words
            .on("end", draw);
        layout.start();

        // This function takes the output of 'layout' above and draw the words
        // Wordcloud features that are THE SAME from one word to the other can be here
        function draw(words) {
            svg.append("g")
                .attr("transform", "translate(" + layout.size()[0]/2 + "," + layout.size()[1]/2 + ")")
                .selectAll("text")
                    .data(words)
                .enter().append("text")
                    .attr("class", function(d,i){ return 'top'+ (i+1)})
                    .attr("text-anchor", "middle")
                    .style("font-family", "Impact")
                    .style("font-size", function(d) { return d.size+"px"; })
                    .style("fill", "#873e23")
                    .attr("transform", function(d) {
                        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                    })
                    .text(function(d) { return d.text; })
                    .on("mouseover", onMouseover)
                    .on("mouseout", onMouseout);
        }

        //the supplimentary horizontal bar chart to show the term frenquency
        // set the dimensions and margins of the graph
        var margin2 = {top: 20, right: 80, bottom: 20, left: 140},
        width2 = 640 - margin2.left - margin2.right,
        height2 = 480 - margin2.top - margin2.bottom;

        // append the svg object to the body of the page
        var svg2 = d3.select("#horizontal-bar").append("svg")
            .attr("width", width2 + margin2.left + margin2.right)
            .attr("height", height2 + margin2.top + margin2.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin2.left + "," + margin2.top + ")");

        // Add X axis
        var x = d3.scale.linear()
            .domain([0, d3.max(topWords.map(function(d){return d.size;}))+5])
            .range([ 0, width2]);
        
        var xAxis = svg2.append("g")
            .attr("transform", "translate(0," + height2 + ")")
            .call(d3.svg.axis().scale(x).orient("bottom"))
            .selectAll("text")
            //.attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "11px");


        // Add X axis label:
        svg2.append("text")
            .attr("text-anchor", "end")
            .attr("x", width2)
            .attr("y", height2-5)
            .text("Inversed YAKE Score")
            .style("font-size", "12px");

        // Y axis
        var y = d3.scale.ordinal()
            .domain(topWords.map(function(d) { return d.word; }))
            //.rangeBands([0, height2])
            .rangePoints([0, height2], 2);
        
        var yAxis = svg2.append("g")
            .call(d3.svg.axis().scale(y).orient("left"))
            .selectAll("text")
            .style("font-size", "10px")

        // Y axis label:
        svg2.append("text")
            .attr("text-anchor", "end")
            //.attr("transform", "rotate(-90)")
            .attr("y", -5)
            .attr("x", 0)
            .text("Top 20 Terms")
            .style("font-size", "12px")

        // Lines
        svg2.selectAll("myline")
            .data(topWords)
            .enter()
            .append("line")
            .attr("x1", function(d) { return x(d.size); })
            .attr("x2", x(0))
            .attr("y1", function(d) { return y(d.word); })
            .attr("y2", function(d) { return y(d.word); })
            .attr("stroke", "grey")

        // Circles
        svg2.selectAll("mycircle")
            .data(topWords)
            .enter()
            .append("circle")
            .attr("class", function(d,i) {return 'top'+ (i+1)})
            .attr("cx", function(d) { return x(d.size); })
            .attr("cy", function(d) { return y(d.word); })
            .attr("r", "4")
            .style("fill", "#873e23")
            .attr("stroke", "black")
            .on("mouseover", onMouseover)
            .on("mouseout", onMouseout);

        function onMouseover(elemData) {
           var kw
           if (elemData.hasOwnProperty('word')){ kw = elemData.word} else {kw = elemData.text}
           
           d3.select("#horizontal-bar").selectAll("circle")
               .select( function(d) {
                   return d.word===kw?this:null;})
               .transition()//Set transition
               .attr("r", "6")
               .style("fill", "#e99c5d");
                   
           d3.select('#word-cloud').selectAll('text')
               .select( function(d) { 
                   return d.text===kw?this:null;})
               .transition()
               //.duration(200)//Set transition
               .style("fill", "#e99c5d");
                  
        }
   
        function onMouseout(elemData) {           
           var kw
           if (elemData.hasOwnProperty('word')){ kw = elemData.word} else {kw = elemData.text}

           d3.select("#horizontal-bar").selectAll("circle")
               .select( function(d) { return d.word===kw?this:null;})
               .transition()//Set transition
               .attr("r", "4")
               .style("fill", "#873e23");
               
           d3.select('#word-cloud').selectAll('text')
               .select( function(d) { return d.text===kw?this:null;})
               .transition().duration(200)//Set transition
               .style("fill", "#873e23");
               
        }
   
    },
    //End of YX KeywordCloud

    //Draws timeline of events highlighting the ones the person has participated in
    visualizePersonEventsTimelineInACommittee: function(the_committee_events) {
        // clear the canvas first
        d3.select('#svg-canvas-person-events-timeline').remove();

        var sessions_objects = the_committee_events;

        var per_session_height = 30;
        var per_session_label = 100;
        var per_event_width = 21;
        var offset_per_event = 2;
        var scale_by = 0.5;
        var original_svg_width = 42;
        var event_participated_in = 0;

        var max_event_in_the_convention = d3.max(sessions_objects, function(d) {
                return d.events.length;
            });

        var margin = {top: 10, right: 10, bottom: 10, left: 0},
            width = max_event_in_the_convention * ((original_svg_width * scale_by) + offset_per_event),
            height = (sessions_objects.length * per_session_height);

        // Define the div for the tooltip
        var div = d3.select('body').append('div')
                .attr('class', 'event-tooltip')
                .style('opacity', 0);

        var dateFormat = d3.time.format('%Y-%m-%dT%H:%M:%S');
        var displayDateFormat = d3.time.format('%a, %e %b %Y');

        if (sessions_objects.length <= 0) {
            //alert('There is no session to be visualize');
        } else {
            var svg = d3.select('#canvas-person-events-timeline')
                    .append('svg')
                    .attr('id', 'svg-canvas-person-events-timeline')
                    .attr('width', width + margin.left + margin.right + per_session_label)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            var g_session = svg.selectAll('g.session-class')
                .data(sessions_objects)
                .enter()
                .append('g')
                    .attr('class', 'session-class')
                    .attr('id', function(a_session) {
                        return 'a_session_' + a_session.session_id;
                    })
                    .attr('transform', function(d, i) {
                        return 'translate(' + margin.left + ',  ' + i * per_session_height + ')';
                    });

            g_session.append('line')
                .attr('class', 'divider')
                .attr('x1', 0)
                .attr('y1', 15)
                .attr('x2', width + per_session_label)
                .attr('y2', 15);

            g_session.append('text')
                .attr('class', 'session_label')
                .attr('x', per_session_label - 15)
                .attr('y', 5)
                .attr('text-anchor', 'end')
                .text(function(a_session) {
                    return displayDateFormat(dateFormat.parse(a_session.session_date))
                });

            g_session.selectAll('g.event')
                .data(function(d) {
                    return d.events;
                })
                .enter()
                .append('g')
                .attr('id', function(an_event) {
                    return 'event_id_' + an_event.id;
                })
                .style('opacity', function(an_event) {
                    if (an_event.associated_event) {
                        event_participated_in = event_participated_in + 1;
                        return 1.0;
                    } else {
                        return 0.25;
                    }
                })
                .attr('class', 'event')
                .on('mouseover', function(an_event) {
                    var name = '';
                    if (an_event.type === 'JOIN' || an_event.type === 'LEAVE' || an_event.type === 'ELECTION' ) {
                        name = an_event.person_name;
                    } else {
                        name = an_event.proposal_name;
                    }
                    div.transition()
                        .duration(200)
                        .style('opacity', .9);
                    div.html(name)
                        .style('left', (d3.event.pageX) + 'px')
                        .style('top', (d3.event.pageY - 28) + 'px');
                    })
                .on('mouseout', function() {
                    div.transition()
                        .duration(500)
                        .style('opacity', 0);
                })
                .on('click', function(an_event) {
                    //window.open(an_event.url, '_blank');
                })
                .attr('transform', function(an_event, i_event) {
                    var img_str = 'img/' + an_event.icon_file;
                    d3.xml(img_str, 'image/svg+xml', function(error, xml) {
                        if (error) throw error;
                        $('#event_id_' + an_event.id).append(xml.getElementsByTagName('svg')[0].getElementsByTagName('g')[0].getElementsByTagName('*'));
                    });

                    var xTranslate = i_event * (original_svg_width * scale_by) + offset_per_event + per_session_label;
                    var yTranslate = -10;
                    return 'translate(' + xTranslate + ',' + yTranslate + ') scale(' + scale_by + ')';
                });

            $('#no-of-events-participated').text(event_participated_in);
        }
    },

    //Gets list of all voting events in all sessions for a single committee. Can include details on voting by selected person and comparison person
    getPersonVotesCommitteeBySession: function() {
        //console.log("getPersonVotesCommitteeBySession called.");
        var response = personVisualize.variables.rawData.getPersonVotesCommitteeBySession;
        personVisualize.variables.votes = response;
        $('#voting-summary-person-name')[0].innerHTML = personVisualize.variables.personName;

        var filteredVotes = personVisualize.prototype.filterVotesByActivity(response.votes);
        personVisualize.variables.filteredVotes = filteredVotes;

        if (typeof response.votes[0] !== 'undefined' && response.votes.length > 0) {
            personVisualize.prototype.visualizePersonVotesInCommittee(filteredVotes, response.max_votes_cast);
        } else {
            // clear the canvas first
            d3.select('#svg-canvas-person-votes-in-committee').remove();
            var svg = d3.select('#canvas-person-votes-in-committee').append('svg')
                        .attr('id', 'svg-canvas-person-votes-in-committee');
            svg.append('text')
                .attr('y', 30)
                .attr('x', 25)
                .text('No votes were cast for this committee.');
        }
    },

    wordWrapper: function(text, width) {
        text.each(function() {
            var text = d3.select(this),
                words = text.text().split(/\s+/).reverse(),
                word,
                line = [],
                lineNumber = 0,
                lineHeight = 1.1, // ems
                y = text.attr("y"),
                x = text.attr("x"),
                dy = 0,
                tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
            while (word = words.pop()) {
                line.push(word);
                tspan.text(line.join(" "));
                if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                    }
                }
            });
    },

    //Draws voting comparison vis
    //This function should be refactored at some point, it is quite messy
    visualizePersonVotesInCommittee:function(committee, max_votes_cast) {
        //console.log("visualizePersonVotesInCommittee called.");
        // clear the canvas first
        d3.select('#svg-canvas-person-votes-in-committee').remove();

        var dateFormat = d3.time.format('%Y-%m-%dT%H:%M:%S');
        var displayDateFormat = d3.time.format('%a, %e %b %Y');

        var numberOfTotalVotesInCommittee = d3.sum(committee.map(function(session) {
           return session.votes.length;
        }));

        var legendHeight = 10;
        var barHeight = 22;
        var decisionWidth = 22;
        var proposalNameWidth = 800;
        var sessionLabelWidth = 100;
        var offsetGroup = 50;
        var margin = {top: 130, right: 50, bottom: 10, left: 10},
            width = 560,
            height = numberOfTotalVotesInCommittee * barHeight;

        var svg = d3.select('#canvas-person-votes-in-committee').append('svg')
                    .attr('id', 'svg-canvas-person-votes-in-committee')
                    .attr('width', width + margin.left + margin.right + decisionWidth + proposalNameWidth + sessionLabelWidth)
                    .attr('height', height + margin.top + margin.bottom + legendHeight);

        svg.append('defs')
            .append('pattern')
            .attr('id', 'diagonalHatch2')
            .attr('patternUnits', 'userSpaceOnUse')
            .attr('width', 4)
            .attr('height', 4)
            .append('path')
            .attr('d', 'M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2')
            .attr('stroke', '#0239D2')
            //.attr('stroke', '#D20933') // this is the way that the VOTE CAST BY THE HILIGHTED PERSON WILL BE SHOWN FOR BOTH VOTES AND ABSTAINING
            .attr('stroke-width', 1.5);

        svg.append('defs')
            .append('pattern')
            .attr('id', 'diagonalHatch1')
            .attr('patternUnits', 'userSpaceOnUse')
            //.attr('patternTransform', 'rotate(90 0 0)')
            .attr('patternTransform', 'translate(2 0)')
            .attr('width', 4)
            .attr('height', 4)
            .append('path')
            .attr('d', 'M1,-1 l-2,2 M4,0 l-4,4 M5,3 l-2,2')
            .attr('stroke', '#DA2A02')
            //.attr('stroke', '#0ACA62')
            .attr('stroke-width', 1.5);

        var x = d3.scale.linear()
            .range([0, width]).domain([-max_votes_cast, max_votes_cast]);

        var y = d3.scale.ordinal()
            .rangeBands([0, height], .1);

        var xAxis = d3.svg.axis()
            .scale(x)
            .tickFormat(function(d) { return Math.abs(d); })
            .tickSize(-height)
            .orient('top');

        var temp = committee.map(function(session) {
            return session.votes.map(function(vote) {
                return vote.event_id;
            });
        });
        y.domain(d3.merge(temp));

        // key
        var g_key = svg.append('g')
                    .attr('id', 'g_key')
                    .attr('transform', 'translate(' + 10 + ',' + 10 + ')');

        //Standard legend
        g_key.append('text')
            .style('font-size', 11)
            .style('font-weight', 'bold')
            .attr('x', 50)
            .attr('y', 7)
            .text('Legend:');

        g_key.append('rect')
            .attr('x', 305)
            .attr('class', 'vote-abstain')
            .attr('width', 10)
            .attr('height', function() {
                return Math.round(y.rangeBand() / 3);
            });

        g_key.append('text')
            .style('font-size', 11)
            .attr('y', 7)
            .attr('x', 322)
            .text('Abstain,');

        g_key.append('rect')
            .attr('y', -6)
            .attr('x', 458)
            .attr('class', 'vote-uncertain')
            .attr('width', 4)
            .attr('height', function(d) {
                return y.rangeBand() - 4;
            });

        g_key.append('text')
            .style('font-size', 11)
            .attr('y', 7)
            .attr('x', 472)
            .text('Uncertain,');

        /*g_key.append('rect')
            .attr('y', -7)
            .attr('x', 550)
            .attr('class', 'vote-bar')
            .attr('width', y.rangeBand())
            .attr('height', y.rangeBand());

        g_key.append('text')
            .style('font-size', 11)
            .attr('y', 7)
            .attr('x', 572)
            .text('No Participation,');*/
        
        //Person1
        g_key.append('text')
            .style('font-size', 13)
            .attr('y', 25)
            .attr('x', 130)
            .text(personVisualize.variables.personName+':');

        g_key.append('rect')
            .attr('y', 13)
            .attr('x', 300)
            .attr('opacity', 0.25)
            .attr('fill', '#0239C2')
            .attr('width', y.rangeBand())
            .attr('height', y.rangeBand());

        g_key.append('text')
            .style('font-size', 11)
            .attr('y', 27)
            .attr('x', 322)
            .text('Participation,');

        g_key.append('rect')
            .attr('y', 13)
            .attr('x', 450)
            .attr('class', 'vote-bar')
            .attr('width', y.rangeBand())
            .attr('height', y.rangeBand());

        g_key.append('rect')
            .attr('y', 13)
            .attr('x', 450)
            .attr('width', y.rangeBand())
            .attr('height', y.rangeBand())
            .attr('fill', 'url(#diagonalHatch2)');

        g_key.append('text')
            .style('font-size', 11)
            .attr('y', 27)
            .attr('x', 472)
            .text('Vote cast.');


        if (personVisualize.variables.secondPersonId != -1){
        //Person2
            g_key.append('text')
                .style('font-size', 11)
                .attr('y', 47)
                .attr('x', 130)
                .text(personVisualize.variables.secondPersonName+':');

            g_key.append('rect')
                .attr('y', 33)
                .attr('x', 300)
                .attr('opacity', 0.25)
                .attr('fill', '#CA2A02')
                //.attr('class', 'vote-bar')
                .attr('width', y.rangeBand())
                .attr('height', y.rangeBand());

            g_key.append('text')
                .style('font-size', 11)
                .attr('y', 47)
                .attr('x', 322)
                .text('Participation,');

            g_key.append('rect')
                .attr('y', 33)
                .attr('x', 450)
                .attr('class', 'vote-bar')
                .attr('width', y.rangeBand())
                .attr('height', y.rangeBand());

            g_key.append('rect')
                .attr('y', 33)
                .attr('x', 450)
                .attr('width', y.rangeBand())
                .attr('height', y.rangeBand())
                .attr('fill', 'url(#diagonalHatch1)');

            g_key.append('text')
                .style('font-size', 11)
                .attr('y', 47)
                .attr('x', 472)
                .text('Vote cast.');


            //Both people
            g_key.append('text')
                .style('font-size', 11)
                .attr('y', 68)
                .attr('x', 130)
                .text('Both people:');

            g_key.append('rect')
                .attr('y', 54)
                .attr('x', 300)
                .attr('opacity', 0.25)
                .attr('fill', '#8A39A2')
                //.attr('class', 'vote-bar')
                .attr('width', y.rangeBand())
                .attr('height', y.rangeBand());

            g_key.append('text')
                .style('font-size', 11)
                .attr('y', 68)
                .attr('x', 322)
                .text('Participation,');

            g_key.append('rect')
                .attr('y', 54)
                .attr('x', 450)
                .attr('class', 'vote-bar')
                .attr('width', y.rangeBand())
                .attr('height', y.rangeBand());

            g_key.append('rect')
                .attr('y', 54)
                .attr('x', 450)
                .attr('width', y.rangeBand())
                .attr('height', y.rangeBand())
                .attr('fill', 'url(#diagonalHatch1)');

            g_key.append('rect')
                .attr('y', 54)
                .attr('x', 450)
                .attr('width', y.rangeBand())
                .attr('height', y.rangeBand())
                .attr('fill', 'url(#diagonalHatch2)');

            g_key.append('text')
                .style('font-size', 11)
                .attr('y', 68)
                .attr('x', 472)
                .text('Vote cast.');
        }


        var focusGroup = svg.append('g')
                            .attr('transform', 'translate(' + offsetGroup + ',' + margin.top + ')');

        // Legend
        focusGroup.append('text')
            .attr('class', 'vote-legend')
            .attr('y', -13)
            .attr('x', decisionWidth + sessionLabelWidth)
            .style('font-weight', 'bold')
            .text('Against');

        focusGroup.append('text')
            .attr('class', 'vote-legend')
            .attr('y', -13)
            .attr('x', width + decisionWidth - 13 + sessionLabelWidth)
            .style('font-weight', 'bold')
            .text('For');

        focusGroup.selectAll('.my_g_votes')
            .data(committee)
            .enter()
            .append('rect')
            .attr('width', width + sessionLabelWidth + decisionWidth + proposalNameWidth)
            .attr('height', function(d) {
                if (d['votes'].length === 0) {
                    return barHeight * 2;
                } else {
                    return (d['votes'].length * barHeight) - 5;
                }
            })
            .attr('y', function(d, i) {
                if (i > 0) {
                    var yCoor = 0;
                    for (var ii = 0; ii <= i - 1; ii++) {
                        if (committee[ii]['votes'].length == 0) {
                            yCoor = yCoor + (2 * barHeight);
                        } else {
                            yCoor = yCoor + (committee[ii]['votes'].length * barHeight);
                        }
                    }

                    return yCoor + 13;
                } else {
                    return 0 + 10;
                }
            })
            .attr('x', -5)
            .style('fill', function(d, i) {
                if (i % 2 === 0) {
                    return '#fff';
                } else {
                    return '#ececec';
                }
            })
            .style('stroke', function(d, i) {
                if (i % 2 === 0) {
                    return '#fff';
                } else {
                    return '#dfdfdf';
                }
            });

        focusGroup.selectAll('.my_text')
            .data(function() {
                return committee.filter(function(session) { return session.session_date; })
            })
            .enter()
            .append('text')
            .attr('class', 'session_vote_label')
            .style('font-weight', 'bold')
            .attr('y', function(d, i) {
                if (i > 0) {
                    var yCoor = 0;
                    for (var ii = 0; ii <= i - 1; ii++) {
                        if (committee[ii]['votes'].length == 0) {
                            yCoor = yCoor + (2 * barHeight);
                        } else {
                            yCoor = yCoor + (committee[ii]['votes'].length * barHeight);
                        }
                    }
                    return yCoor + 22;
                } else {
                    return 0 + 22;
                }
            })
            .attr('x', 5)
            .text(function(d) {
                return displayDateFormat(dateFormat.parse(d.session_date));
            });

        var big_graph = focusGroup.append('g')
            .attr('transform', 'translate(' + (decisionWidth + sessionLabelWidth) + ',' + legendHeight + ')');

        var graph = big_graph.selectAll('.my_g_votes')
            .data(committee)
            .enter()
            .append('g');

        // vote cast - for
        graph.selectAll('.bar-for')
            .data(function(d) {
                return d.votes;
            })
            .enter().append('rect')
            //.attr('class', 'vote-bar')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['FOR'];
                return x(Math.min(0, value));
            })
            .attr('y', function (d) {
                return y(d.event_id);
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['FOR'];
                return Math.abs(x(value) - x(0));
            })
            .attr('height', y.rangeBand())
            .attr('fill', function(d){
                if (d.participated && d.second_participated)
                    return '#8A39A2';
                if (d.participated)
                    return '#0239D2';
                if (d.second_participated)
                    return '#DA2A02';
            })
            .attr('opacity', function(d) {
                    //if (d.participated) {
                    //    return 1.0;
                    //} else {
                        return 0.25;
                    //}
                })
                .on('mouseover', displayDecisionDetails)
                .on('mouseout', hideDecisionDetails);

        // vote cast - against
        graph.selectAll('.bar-against')
            .data(function(d) {
                return d.votes;
            })
            .enter().append('rect')
            //.attr('class', 'vote-bar')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['AGAINST'];
                return x(Math.min(0, -value));
            })
            .attr('y', function (d) {
                return y(d.event_id);
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['AGAINST'];
                return Math.abs(x(-value) - x(0));
            })
            .attr('height', y.rangeBand())
            .attr('fill', function(d){
                if (d.participated && d.second_participated)
                    return '#8A39A2';
                if (d.participated)
                    return '#0239C2';
                if (d.second_participated)
                    return '#CA2A02';
            })
            .attr('opacity', function(d) {
                    //if (d.participated) {
                    //    return 1.0;
                    //} else {
                        return 0.25;
                    //}
                })
                .on('mouseover', displayDecisionDetails)
                .on('mouseout', hideDecisionDetails);

        //highlighting vote cast by second person
        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) { if (vote.second_participated) return vote;} )
            })
            .enter()
            .append('rect')
            .attr('x', function(d) {
                var vote_casted = '';
                if (personVisualize.variables.type === 'delegation') {
                    vote_casted = d.second_delegation_vote_cast;
                } else {
                    vote_casted = d.second_person_vote_cast;
                }
                var value = d['vote_types_cast'][vote_casted];
                var coor;
                if (vote_casted === 'AGAINST') {
                    coor = -value;
                } else {
                    if (vote_casted === 'FOR') {
                        coor = value;
                    } else {
                        coor = 0;
                    }
                }
                return x(Math.min(0, coor));
            })
            .attr('y', function(d) { return y(d.event_id); })
            .attr('height', y.rangeBand())
            .attr('width', function(d) {
                var vote_casted = '';
                if (personVisualize.variables.type === 'delegation') {
                    vote_casted = d.second_delegation_vote_cast;
                } else {
                    vote_casted = d.second_person_vote_cast;
                }
                var value = d['vote_types_cast'][vote_casted];
                var coor;
                if (vote_casted === 'AGAINST') {
                    coor = -value;
                } else {
                    if (vote_casted === 'FOR') {
                        coor = value;
                    } else {
                        coor = 0;
                    }
                }
                return Math.abs(x(coor) - x(0));
            })
            .attr('fill', 'url(#diagonalHatch1)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        // highlighting the vote cast (for or against)
        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) { if (vote.participated) return vote;} )
            })
            .enter()
            .append('rect')
            .attr('x', function(d) {
                var vote_casted = '';
                if (personVisualize.variables.type === 'delegation') {
                    vote_casted = d.delegation_vote_cast;
                } else {
                    vote_casted = d.person_vote_cast;
                }
                var value = d['vote_types_cast'][vote_casted];
                var coor;
                if (vote_casted === 'AGAINST') {
                    coor = -value;
                } else {
                    if (vote_casted === 'FOR') {
                        coor = value;
                    } else {
                        coor = 0;
                    }
                }
                return x(Math.min(0, coor));
            })
            .attr('y', function(d) { return y(d.event_id); })
            .attr('height', y.rangeBand())
            .attr('width', function(d) {
                var vote_casted = '';
                if (personVisualize.variables.type === 'delegation') {
                    vote_casted = d.delegation_vote_cast;
                } else {
                    vote_casted = d.person_vote_cast;
                }
                var value = d['vote_types_cast'][vote_casted];
                var coor;
                if (vote_casted === 'AGAINST') {
                    coor = -value;
                } else {
                    if (vote_casted === 'FOR') {
                        coor = value;
                    } else {
                        coor = 0;
                    }
                }
                return Math.abs(x(coor) - x(0));
            })
            .attr('fill', 'url(#diagonalHatch2)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        // vote cast - abstain
        graph.selectAll('.bar-abstain-left')
            .data(function(d) {
                return d.votes;
            })
            .enter().append('rect')
            .attr('class', 'vote-abstain')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return x(Math.min(0, -value));
            })
            .attr('y', function (d) {
                return y(d.event_id) + 6;
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return Math.abs(x(-value) - x(0));
            })
            .attr('height', function(d) {
                return Math.round(y.rangeBand() / 3);
            })
            .attr('opacity', function(d) {
                if (d.participated) {
                    return 1.0;
                } else {
                    return 0.45;
                }
            })
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        graph.selectAll('.bar-abstain-right')
            .data(function(d) {
                return d.votes;
            })
            .enter().append('rect')
            .attr('class', 'vote-abstain')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return x(Math.min(0, value));
            })
            .attr('y', function (d) {
                return y(d.event_id) + 6;
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return Math.abs(x(value) - x(0));
            })
            .attr('height', function(d) {
                return Math.round(y.rangeBand() / 3);
            })
            .attr('opacity', function(d) {
                if (d.participated) {
                    return 1.0;
                } else {
                    return 0.45;
                }
            })
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        // highlighting (abstain) for second person
        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.second_delegation_vote_cast;
                    } else {
                        vote_casted = vote.second_person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'ABSTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return x(Math.min(0, -value));
            })
            .attr('y', function (d) {
                return y(d.event_id) + 6;
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return Math.abs(x(-value) - x(0));
            })
            .attr('height', function(d) {
                return Math.round(y.rangeBand() / 3);
            })
            .attr('fill', 'url(#diagonalHatch1)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);
        
        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.second_delegation_vote_cast;
                    } else {
                        vote_casted = vote.second_person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'ABSTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return x(Math.min(0, value));
            })
            .attr('y', function (d) {
                return y(d.event_id) + 6;
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return Math.abs(x(value) - x(0));
            })
            .attr('height', function(d) {
                return Math.round(y.rangeBand() / 3);
            })
            .attr('fill', 'url(#diagonalHatch1)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        // highlighting the vote casted (abstain)
        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.delegation_vote_cast;
                    } else {
                        vote_casted = vote.person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'ABSTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return x(Math.min(0, -value));
            })
            .attr('y', function (d) {
                return y(d.event_id) + 6;
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return Math.abs(x(-value) - x(0));
            })
            .attr('height', function(d) {
                return Math.round(y.rangeBand() / 3);
            })
            .attr('fill', 'url(#diagonalHatch2)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.delegation_vote_cast;
                    } else {
                        vote_casted = vote.person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'ABSTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return x(Math.min(0, value));
            })
            .attr('y', function (d) {
                return y(d.event_id) + 6;
            })
            .attr('width', function (d) {
                var value = d['vote_types_cast']['ABSTAIN'];
                return Math.abs(x(value) - x(0));
            })
            .attr('height', function(d) {
                return Math.round(y.rangeBand() / 3);
            })
            .attr('fill', 'url(#diagonalHatch2)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        // vote cast - uncertain
        graph.selectAll('.bar-uncertain-left')
            .data(function(d) {
                return d.votes;
            })
            .enter().append('rect')
            .attr('class', 'vote-uncertain')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['UNCERTAIN'];
                return x(Math.min(0, -value)) - 2;
            })
            .attr('y', function (d) {
                return y(d.event_id) + 2;
            })
            .attr('width', 4)
            .attr('height', function(d) {
                return y.rangeBand() - 4;
            })
            .attr('opacity', function(d) {
                    if (d.participated) {
                        return 1.0;
                    } else {
                        return 0.45;
                    }
                })
                .on('mouseover', displayDecisionDetails)
                .on('mouseout', hideDecisionDetails);

        graph.selectAll('.bar-uncertain-right')
            .data(function(d) {
                return d.votes;
            })
            .enter().append('rect')
            .attr('class', 'vote-uncertain')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['UNCERTAIN'];
                return x(Math.max(0, value)) - 2;
            })
            .attr('y', function (d) {
                return y(d.event_id) + 3;
            })
            .attr('width', 4)
            .attr('height', function(d) {
                return y.rangeBand() - 5;
            })
            .attr('opacity', function(d) {
                    if (d.participated) {
                        return 1.0;
                    } else {
                        return 0.45;
                    }
                })
                .on('mouseover', displayDecisionDetails)
                .on('mouseout', hideDecisionDetails);


        // highlighting (uncertain) for second person
        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.second_delegation_vote_cast;
                    } else {
                        vote_casted = vote.second_person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'UNCERTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['UNCERTAIN'];
                return x(Math.min(0, -value)) - 2;
            })
            .attr('y', function (d) {
                return y(d.event_id) + 2;
            })
            .attr('width', 4)
            .attr('height', function(d) {
                return y.rangeBand() - 4;
            })
            .attr('fill', 'url(#diagonalHatch1)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.second_delegation_vote_cast;
                    } else {
                        vote_casted = vote.second_person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'UNCERTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['UNCERTAIN'];
                return x(Math.max(0, value)) - 2;
            })
            .attr('y', function (d) {
                return y(d.event_id) + 3;
            })
            .attr('width', 4)
            .attr('height', function(d) {
                return y.rangeBand() - 5;
            })
            .attr('fill', 'url(#diagonalHatch1)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);


        // highlighting the vote casted (uncertain)
        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.delegation_vote_cast;
                    } else {
                        vote_casted = vote.person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'UNCERTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['UNCERTAIN'];
                return x(Math.min(0, -value)) - 2;
            })
            .attr('y', function (d) {
                return y(d.event_id) + 2;
            })
            .attr('width', 4)
            .attr('height', function(d) {
                return y.rangeBand() - 4;
            })
            .attr('fill', 'url(#diagonalHatch2)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        graph.selectAll('.my_rect')
            .data(function(d) {
                return d.votes.filter(function(vote) {
                    var vote_casted = '';
                    if (personVisualize.variables.type === 'delegation') {
                        vote_casted = vote.delegation_vote_cast;
                    } else {
                        vote_casted = vote.person_vote_cast;
                    }
                    if (vote.participated && vote_casted === 'UNCERTAIN') return vote;
                });
            })
            .enter()
            .append('rect')
            .attr('x', function (d) {
                var value = d['vote_types_cast']['UNCERTAIN'];
                return x(Math.max(0, value)) - 2;
            })
            .attr('y', function (d) {
                return y(d.event_id) + 3;
            })
            .attr('width', 4)
            .attr('height', function(d) {
                return y.rangeBand() - 5;
            })
            .attr('fill', 'url(#diagonalHatch2)')
            .on('mouseover', displayDecisionDetails)
            .on('mouseout', hideDecisionDetails);

        var x_axis = big_graph.append('g')
            .attr('class', 'x axis')
            .call(xAxis);

        x_axis.append('line')
            .attr('x1',0)
            .attr('x2',width)
            .attr('y1',height)
            .attr('y2',height);

        big_graph.append('g')
            .attr('class', 'y axis')
            .append('line')
            .attr('x1', x(0))
            .attr('x2', x(0))
            .attr('y2', height);


        //selection box
        /*graph.selectAll('.my_votes')
        .data(function(d) {
            return d.votes.filter(function(vote) { if (vote.participated) return vote;} )
        })
        .enter()
        .append('rect')
        .attr('id', function(d) {
            return 'focus-vote-in-committee-highlight-box-' + d.event_id;
        })
        .attr('height', function() {
            return y.rangeBand() + 4;
        })
        .attr('width', function(d) {
            var value_for = d['vote_types_cast']['FOR'];
            value_for = Math.abs(x(-value_for) - x(0))
            var value_against = d['vote_types_cast']['AGAINST'];
            value_against = Math.abs(x(value_against) - x(0))
            return value_for + value_against + 4;
        })
        .attr('x', function (d) {
            var value = d['vote_types_cast']['AGAINST'];
            return x(Math.min(0, -value)) - 2;
        })
        .attr('y', function(d) {
            return y(d.event_id) - 2;
        })
        .attr('stroke', '2,2')
        .style('fill-opacity', 0);*/


        // adding the voting decisions
        graph.selectAll('.vote2-svg')
            .data(function(d) {
                return d.votes;
            })
            .enter().append('g')
            .attr('id', function(d) {
                return 'vote_in_committee_id_' + d.event_id;
            })
            .attr('transform', function(d) {
                    var img_str = '';
                    switch (d.voting_decision) {
                        case 'ADOPT_PROPOSAL':
                            img_str = 'img/' + QUILL_ICONS['ADOPT_PROPOSAL'];
                            break;
                        case 'NO_OBJECTION':
                            img_str = 'img/' + QUILL_ICONS['NO_OBJECTION'];
                            break;
                        case 'REJECT_PROPOSAL':
                            img_str = 'img/' + QUILL_ICONS['REJECT_PROPOSAL'];
                            break;
                        case 'DROP_PROPOSAL':
                            img_str = 'img/' + QUILL_ICONS['DROP_PROPOSAL'];
                            break;
                        case 'REPORT_PROPOSAL':
                            img_str = 'img/' + QUILL_ICONS['REPORT_PROPOSAL'];
                            break;
                        case 'OTHER':
                            img_str = 'img/' + QUILL_ICONS['OTHER'];
                            break;
                        case 'POSTPONE_DEBATE':
                            img_str = 'img/' + QUILL_ICONS['POSTPONE_DEBATE'];
                            break;
                    }
                    d3.xml(img_str, 'image/svg+xml', function(error, xml) {
                        if (error) throw error;
                        document.getElementById('vote_in_committee_id_' + d.event_id).appendChild(xml.getElementsByTagName('svg')[0].getElementsByTagName('g')[0]);
                    });

                    return 'translate(' + -20 + ',' + y(d.event_id) + ') scale(' + 0.4 + ')';
                })
            .attr('opacity', function(d) {
                    if (d.participated) {
                        return 1.0;
                    } else {
                        return 0.45;
                    }
                });

        // adding the proposal names
        graph.selectAll('.vote-proposal-name')
            .data(function(d) {
                return d.votes;
            })
            .enter()
            /*.append("svg:a")
            .attr("xlink:href", function(d){
                return d.url;
            })
            .attr("target", "_blank")*/
            .append('text')
            .attr('class', 'vote-proposal-name')
            .attr('id', function(d) {
                return 'vote_proposal_name_id_' + d.event_id;
            })
            .attr('transform', function(d) {
                    return 'translate(' + (width + decisionWidth) + ',' + (y(d.event_id) + Math.round(barHeight / 2) + 2) + ')';
                })
            .text(function(d) {
                return d.proposal_name;
            })
            .attr('opacity', function(d) {
                    if (d.participated) {
                        return 1.0;
                    } else {
                        return 0.45;
                    }
                });


        personVisualize.prototype.visualizeVotesInCommitteeOverview(committee, svg, margin);

        var div = d3.select('body').append('div')
            .attr('class', 'vote-detail-tooltip')
            .style('opacity', 0);

        function displayDecisionDetails(d) {
            var description = d.proposal_name+'<br>For: '+
                d.vote_types_cast.FOR+'<br>Agaist: '+d.vote_types_cast.AGAINST+'<br>Abstain: '+
                d.vote_types_cast.ABSTAIN+'<br>Uncertain: '+d.vote_types_cast.UNCERTAIN+
                '<br>Decision: '+d.voting_decision;
            div.transition()
                .duration(200)
                .style('opacity', .9);
            div.html(description)
                .style('left', (d3.event.pageX) + 'px')
                .style('top', (d3.event.pageY - 85) + 'px');
        }
        function hideDecisionDetails(d) {
            div.transition()
                .duration(500)
                .style('opacity', 0);
        }
    },

    //Draws overview bar for voting on the left side of the vote view svg
    visualizeVotesInCommitteeOverview: function(committee, svg, margin) {
        //console.log("visualizeVotesInCommitteeOverview called.");
        var objHeight = 10;
        var objWidth = 10;
        var objOffset = 2;
        var scaleBy = 0.2;

        // get the first vote
        var firstVoteEventId = -1;
        var toBreak = false;
        for (var ic = 0; ic < committee.length; ic++) {
            var my_session = committee[ic];
            for (var is = 0; is < my_session.votes.length; is++) {
                if (my_session.votes[is]['participated']) {
                    firstVoteEventId = my_session.votes[is]['event_id'];
                    toBreak = true;
                    break;
                }
            }
            if (toBreak) {
                break;
            }
        }

        var gOverviewVotes = svg.append('g').attr('id', 'session_votes_overview_group_2')
            .attr('transform', 'translate(' + 10 + ',' + 135 + ')')
            .selectAll('.g_overview_in_committee')
            .data(committee)
            .enter()
            .append('g')
            .attr('transform', function(d, i) {
                if (i > 0) {
                    var yCoor = 0;
                    for (var local_i = 0; local_i <= i - 1; local_i++) {
                        for (var ind = 0; ind < committee[local_i]['votes'].length; ind++) {
                            var my_vote = committee[local_i]['votes'][ind];
                            if (my_vote.participated) {
                                yCoor = yCoor + objHeight + objOffset;
                            } else {
                                yCoor = yCoor + Math.ceil(objHeight * scaleBy) + objOffset;
                            }
                        }
                         yCoor = yCoor + (objOffset);
                    }
                    return 'translate(' + 0 + ',' + yCoor + ')';
                } else {
                    return 'translate(' + 0 + ',' + 0 + ')';
                }
            });

        gOverviewVotes.append('rect')
            .attr('x', -2)
            .attr('y', -1)
            .attr('width', objWidth + 4)
            .attr('height', function(d, i) {
                var my_height = 0;
                for (var inner_i = 0; inner_i < d.votes.length; inner_i++) {
                    var my_vote = d.votes[inner_i];
                    if (my_vote.participated) {
                        my_height = my_height + objHeight + objOffset;
                    } else {
                        my_height = my_height + Math.ceil(objHeight * scaleBy) + objOffset;
                    }
                }
                my_height = my_height + 1;
                return my_height;
            })
            .style('fill', function(d, i) {
                if (i % 2 === 0) {
                    return '#fff';
                } else {
                    return '#dfdfdf';
                }
            })
            .style('stroke', function(d, i) {
                if (i % 2 === 0) {
                    return '#fff';
                } else {
                    return '#7d7d7d';
                }
            })
            .style('stroke-opacity', function(d, i) {
                if (i % 2 === 0) {
                    return 0;
                } else {
                    return 1;
                }
            })
            .style('fill-opacity', 0);

        // Define the div for the tooltip
        var div = d3.select('body').append('div')
            .attr('class', 'vote-overview-tooltip')
            .style('opacity', 0);

        gOverviewVotes.selectAll('.overview_votes_in_committee')
            .data(function(d) {
                return d.votes;
            })
            .enter()
            .append('rect')
            .attr('id', function (d) {
                return 'overview-vote-in-committee-highlight-box-' + d.event_id;
            })
            .attr('height', function (d) {
                if (d.participated) {
                    return objHeight + 2;
                } else {
                    return Math.round((objHeight + 2) * scaleBy);
                }
            })
            .attr('width', objWidth + 2)
            .attr('x', -1)
            .attr('y', function (d, i) {
                if (i > 0) {
                    var my_y = d3.select(this.previousSibling).attr('y');
                    var my_height = d3.select(this.previousSibling).attr('height');
                    if (parseInt(my_height) === Math.round((objHeight + 2) * scaleBy)) {
                        return parseInt(my_y) + parseInt(my_height) + objOffset;
                    } else {
                        return parseInt(my_y) + parseInt(my_height) + objOffset - 2;
                    }
                } else {
                    return 0 - 1;
                }
            })
            .attr('stroke', '2,2')
            .style('fill-opacity', 0);

        gOverviewVotes.selectAll('.overview_votes_in_committee')
            .data(function(d) {
                return d.votes;
            })
            .enter()
            .append('rect')
            .attr('id', function (d) {
                return 'overview-vote-in-committee-box-' + d.event_id;
            })
            .attr('height', function (d) {
                if (d.participated) {
                    return objHeight;
                } else {
                    return Math.round(objHeight * scaleBy);
                }
            })
            .attr('width', objWidth)
            .attr('y', function (d, i) {
                if (i > 0) {
                    var my_y = d3.select(this.previousSibling).attr('y');
                    var my_height = d3.select(this.previousSibling).attr('height');
                    return parseInt(my_y) + parseInt(my_height) + objOffset;
                } else {
                    return 0;
                }
            })
            .attr('class', function (d) {
                if (d.participated) {
                    return 'votes-overview votes-overview-can-be-selected';
                } else {
                    return 'votes-overview';
                }
            })
            .style('opacity', function (d) {
                if (d.participated) {
                    return 1.0;
                } else {
                    return 0.45;
                }
            })
            .on('click', function (d) {
                if (d.participated) {
                    // Find previously selected, unselect
                    d3.select('.overview-vote-in-committee-selected').classed('overview-vote-in-committee-selected', false);
                    d3.select('#overview-vote-in-committee-highlight-box-' + d.event_id).classed('overview-vote-in-committee-selected', true);
                    d3.select('.focus-vote-in-committee-selected').classed('focus-vote-in-committee-selected', false);
                    d3.select('#focus-vote-in-committee-highlight-box-' + d.event_id).classed('focus-vote-in-committee-selected', true);
                }
            })
            .on('mouseover', function (d) {
                div.transition()
                    .duration(200)
                    .style('opacity', .9);
                div.html(d.proposal_name)
                    .style('left', (d3.event.pageX) + 'px')
                    .style('top', (d3.event.pageY - 28) + 'px');
            })
            .on('mouseout', function (d) {
                div.transition()
                    .duration(500)
                    .style('opacity', 0);
            });

        //d3.select('#overview-vote-in-committee-highlight-box-' + firstVoteEventId).classed('overview-vote-in-committee-selected', true);
        //d3.select('#focus-vote-in-committee-highlight-box-' + firstVoteEventId).classed('focus-vote-in-committee-selected', true);
    },

    //Returns a filtered copy of committee vote data with no 0-vote sessions/events.
    filterVotesByActivity: function(committee) {
        var output = committee.map(function(s){
            var newSession = {
                'committee_id' : s.committee_id,
                'committee_name' : s.committee_name,
                'session_date' : s.session_date,
                'session_id' : s.session_id,
                'url' : s.url,
                'votes' : s.votes.filter(function(v){
                    return (v.max_votes_cast > 0);})
            }
            return newSession;
        })

        output = output.filter(function(s){
            return (s.votes.length != 0);
        })

        return output;
    
    },

    //Returns a filtered committee event array with only sessions with participation from selected person
    filterEventsByParticipation: function(events) {
        /*var output = events.map(function(s){
            var newSession = {
                'committee_id' : s.committee_id,
                'committee_name' : s.committee_name,
                'session_date' : s.session_date,
                'session_id' : s.session_id,
                'icon_file' : s.icon_file,
                'events' : s.events.filter(function(e){
                    return (e.associated_event == true);})
            }
            return newSession;
        })

        output = output.filter(function(s){
            return (s.events.length != 0);
        })*/

        var output = events.filter(function(s){
            if (s.events.find(function(e){
                return e.associated_event == true;
            })) return true;
        })

        return output;
    },

    //Gets distances to selected person and projection xy positions from all people in convention
    getPersonRelationships: function(){
        //console.log("getPersonRelationships called.");
        var response = personVisualize.variables.rawData.personRelationshipsCommittee;
        personVisualize.variables.relationships = response;
        $('#relationships-person-name')[0].innerHTML = personVisualize.variables.personName;
        $('#relationships-committee-name')[0].innerHTML = personVisualize.variables.committeeName;


        if (typeof response != 'undefined' && response.people.length > 0) {
            personVisualize.prototype.visualizePersonRelationships(response.people, response.number_of_times_voted, personVisualize.variables.personId);

            d3v5.selectAll("#selector-person-comparison").selectAll(".extra")
                .data([...response.people].sort(function(a,b){return (a.person_name > b.person_name ? 1 : -1);}))
                .join("option")
                    .html(function(d){return d.person_name+' ('+(d.distance_to_selected_person/(response.number_of_times_voted*4)).toFixed(2)+')';})
                    .attr("class","extra")
                    .attr("value",function(d){return d.person_id;});

        } else {
            // clear the canvas first
            d3.select('#svg-canvas-neighborhood-projection').remove();
            var svg = d3.select('#canvas-neighborhood-projection').append('svg')
                        .attr('id', 'svg-canvas-neighborhood-projection');
            svg.append('text')
                .attr('y', 30)
                .attr('x', 25)
                .text('No relationship information could be obtained for this person.');
        }
    },

    //Displays neighborhood scatterplot and allies/enemies
    visualizePersonRelationships: function(people,maxVotes,selectedPersonId){
        //console.log("visualizePersonRelationships called.");
        var projWidth = 640;
        var projHeight = 480;
        var projMargin = 10;

        var wHeight = 450;
        var wWidth = 500;

        d3v5.select('#allies-enemies-container')
            .style("vertical-align","top")
            .style("padding","10px");

        people.sort(function(a,b){return a.distance_to_selected_person - b.distance_to_selected_person;});
        var selectedPerson = people.find(function(d){return d.person_id == selectedPersonId;});

        var colorScaleAlly = d3v5.scaleSequential(d3v5.interpolateGnBu).domain([people[people.length-1].distance_to_selected_person,0]);
        var colorScaleEnemy = d3v5.scaleSequential(d3v5.interpolateOrRd).domain([0,people[people.length-1].distance_to_selected_person]);

        d3v5.select("#allies-display").selectAll("span").remove();
        d3v5.select("#allies-display").selectAll("span")
            .data(people.slice(1,6))
            .join("span")
                .attr("style","font-size:120%")
                .append("a")
                    .attr("style",function(d){return "color: "+colorScaleAlly(d.distance_to_selected_person);})
                    //.attr("href",function(d){return "/person_visualize2/"+personVisualize.variables.convention.convention_id+"/"+d.person_id;})
                    .text(function(d){return d.person_name + " (" + (d.distance_to_selected_person/(maxVotes*4)).toFixed(2) + ")"})
                    .append("br");

        d3v5.select("#enemies-display").selectAll("span").remove();
        d3v5.select("#enemies-display").selectAll("span")
            .data(people.slice(-5).reverse())
            .join("span")
                .attr("style","font-size:120%")
                .append("a")
                    .attr("style",function(d){return "color: "+colorScaleEnemy(d.distance_to_selected_person);})
                    //.attr("href",function(d){return "/person_visualize2/"+personVisualize.variables.convention.convention_id+"/"+d.person_id;})
                    .text(function(d){return d.person_name + " (" + (d.distance_to_selected_person/(maxVotes*4)).toFixed(2) + ")"})
                    .append("br");

        //Very ad-hoc approach to estimating how scatterplot should be scaled by default to show local neighborhood
        //Change it later?
        var zoomlvl = (1+people.length/25);

        //var extentX = d3.extent(people.map(function(d){return d.px;}));
        //Having different xmax and ymax for each person page may cause varying aspect ratios
        var xmax = d3.max(people.map(function(d){return Math.abs(d.px);}));
        var projScaleX = d3v5.scaleLinear()
            .domain([-xmax/zoomlvl,xmax/zoomlvl])
            .range([projMargin,projWidth-projMargin]);

        var ymax = d3.max(people.map(function(d){return Math.abs(d.py);}));
        var projScaleY = d3v5.scaleLinear()
            .domain([-ymax/zoomlvl,ymax/zoomlvl])
            .range([projMargin,projHeight-projMargin]);

        d3v5.select("#canvas-neighborhood-projection").selectAll("#svg-canvas-neighborhood-projection").remove();
        var svg = d3v5.select("#canvas-neighborhood-projection").append("svg")
            .attr("id","svg-canvas-neighborhood-projection")
            .attr("height",projHeight)
            .attr("width",projWidth);

        svg.append("defs")
            .append("clipPath")
                .attr("id","projClip")
                .append("rect")
                    .attr("x",projMargin)
                    .attr("y",projMargin)
                    .attr("width",projWidth-(projMargin*2))
                    .attr("height",projHeight-(projMargin*2));

        svg.append("g")
            .attr("transform","translate(0,"+(projHeight-projMargin)+")")
            .call(d3v5.axisBottom(projScaleX)
                .tickValues([])
            );
        
        svg.append("g")
            .attr("transform","translate("+projMargin+",0)")
            .call(d3v5.axisLeft(projScaleY)
                .tickValues([])
            );

        svg.append("g")
            .attr("transform","translate(0,"+(projHeight-projMargin)+")")
            .call(d3v5.axisBottom(projScaleX)
                .ticks(5)
                .tickSize(-projHeight+(projMargin*2))
                .tickFormat("")
            ).attr("opacity",0.4);

        svg.append("g")
            .attr("transform","translate("+projMargin+",0)")
            .call(d3v5.axisLeft(projScaleY)
                .ticks(5)
                .tickSize(-projWidth+(projMargin*2))
                .tickFormat("")
            ).attr("opacity",0.4);

        var dotgroups = svg.append("g").selectAll(".dot-person")
            .data([...people].reverse())
            .join("g")
                .attr("class","dot-person")
                .attr("style","clip-path: url(#projClip)");
        
        var dots = dotgroups.append("circle")
            .attr("class","dot")
            .attr("cx",function(d){return projScaleX(d.px);})
            .attr("cy",function(d){return projScaleY(d.py);})
            .attr("r",5)
            .attr("style",function(d,di){return d.person_id == selectedPersonId? "fill:black" : ""});
            

        var labels = dotgroups.append("text")
            .attr("class", "dot-label")
            .attr("x", function(d) {return (projScaleX(d.px) - 2);})
            .attr("y", function(d) {return (projScaleY(d.py) - 7);})
            .attr("font-size","12px")
            .attr("opacity",function(d,di){return d.person_id == selectedPersonId? 1.0 : 0.35;})
            .text(function(d){return d.person_name;});

        svg.append("text")
            .attr("x",30)
            .attr("y",40)
            .attr("font-size","16px")
            .attr("font-family","Tahoma")
            .attr("font-weight","bold")
            .html("Neighborhood map");
    },

};

personVisualize.prototype.init();